# Sesterce Secure Dashboard Deployment Guide

## Overview

This guide covers the secure deployment of the Sesterce Dashboard with protected business logic using a backend API.

## Architecture

```
┌─────────────┐     ┌─────────────┐     ┌──────────────┐
│   Browser   │────▶│    Nginx    │────▶│  React App   │
│             │     │   (7777)    │     │   (Static)   │
└─────────────┘     └──────┬──────┘     └──────────────┘
                           │
                           │ /api/*
                           ▼
                    ┌──────────────┐
                    │  Flask API   │
                    │   (7778)     │
                    │              │
                    │ • Calculations│
                    │ • Business    │
                    │   Logic       │
                    │ • Rate Limit  │
                    └──────────────┘
```

## Security Features

1. **No Client-Side Business Logic**: All calculations happen server-side
2. **API Authentication**: Request signature validation
3. **Rate Limiting**: 10 requests/minute per IP
4. **Source Maps Disabled**: No debugging information in production
5. **CORS Protection**: API only accepts requests from your domain

## Quick Start

### 1. Initial Setup

```bash
# Run the secure setup script
./setup-secure-dashboard.sh
```

This will:
- Install all dependencies (Node.js, Python, Nginx)
- Create Python virtual environment
- Install Flask and dependencies
- Generate secure API keys
- Build the React app
- Configure Nginx

### 2. Start Services

```bash
# Start all services
./secure-dashboard start

# Check status
./secure-dashboard status
```

### 3. Access Dashboard

Open: http://localhost:3025

## Deployment Steps for Ubuntu

### Step 1: Install Dependencies

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install -y nodejs npm python3 python3-pip nginx git
```

### Step 2: Clone and Setup

```bash
# Clone repository
git clone <your-repo-url> sesterce-dashboard
cd sesterce-dashboard

# Run secure setup
./setup-secure-dashboard.sh
```

### Step 3: Configure Services

The setup script automatically creates:
- SystemD service for API: `/etc/systemd/system/sesterce-calculator-api.service`
- Nginx configuration: `/etc/nginx/sites-available/sesterce-secure`

### Step 4: Start Services

```bash
# Start API service
sudo systemctl start sesterce-calculator-api
sudo systemctl enable sesterce-calculator-api

# Start Nginx
sudo systemctl restart nginx
```

### Step 5: Configure Firewall

```bash
# Allow port 7777
sudo ufw allow 7777/tcp
sudo ufw reload
```

## Management Commands

```bash
# Start all services
./secure-dashboard start

# Stop all services
./secure-dashboard stop

# Restart services
./secure-dashboard restart

# Check status
./secure-dashboard status

# View logs
./secure-dashboard logs

# Rebuild React app
./secure-dashboard build

# Test API
./secure-dashboard test
```

## Environment Configuration

### React App (.env.production)
```
GENERATE_SOURCEMAP=false
REACT_APP_CALCULATOR_API_URL=/api
REACT_APP_CALCULATOR_API_SECRET=<auto-generated>
```

### API Server (.env)
```
CALCULATOR_API_SECRET=<auto-generated>
FLASK_ENV=production
```

## Updating the Calculator

To use the secure calculator:

1. Edit `sesterce-dashboard/src/App.tsx`:
```javascript
// Replace this:
import { GPUSuperclusterCalculator } from './components/features/GPUSuperclusterCalculator';

// With this:
import { GPUSuperclusterCalculatorSecure } from './components/features/GPUSuperclusterCalculatorSecure';
```

2. Update the component usage:
```javascript
{activeTab === 'calculator' && <GPUSuperclusterCalculatorSecure />}
```

3. Rebuild:
```bash
./secure-dashboard build
```

## Production Deployment

### 1. Domain Setup

Update CORS in `calculator-api.py`:
```python
CORS(app, origins=['https://yourdomain.com'])
```

### 2. HTTPS Configuration

Add SSL to Nginx:
```nginx
server {
    listen 443 ssl;
    server_name yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # ... rest of config
}
```

### 3. Production API

Use production WSGI server:
```bash
# Install
pip install gunicorn

# Run with more workers
gunicorn -w 8 -b 127.0.0.1:7778 calculator-api:app
```

### 4. Monitoring

Set up monitoring for:
- API response times
- Rate limit violations
- Error rates
- Resource usage

## Security Best Practices

1. **Change API Secret**: Update the auto-generated secret in production
2. **Restrict CORS**: Only allow your production domain
3. **Enable HTTPS**: Use SSL certificates in production
4. **Monitor Logs**: Watch for suspicious activity
5. **Update Dependencies**: Keep all packages up to date
6. **Backup**: Regular backups of configuration

## Troubleshooting

### API Not Responding
```bash
# Check API status
./secure-dashboard status

# View API logs
./secure-dashboard logs

# Test API directly
curl http://localhost:7778/api/health
```

### Nginx Issues
```bash
# Test configuration
sudo nginx -t

# Check error logs
sudo tail -f /var/log/nginx/sesterce-secure-error.log
```

### Permission Issues
```bash
# Fix file permissions
sudo chown -R $USER:$USER /path/to/sesterce-dashboard
sudo chmod -R 755 /path/to/sesterce-dashboard
```

## Support

For issues or questions:
1. Check logs: `./secure-dashboard logs`
2. Test API: `./secure-dashboard test`
3. Review security guide: `SECURITY-GUIDE.md`
